<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="ç«‹å†¬ç¥ç¦ - æ¸©æš–æ²»æ„ˆçš„å†¬æ—¥ç¥ç¦ä½“éªŒ">
    <meta name="theme-color" content="#667eea">
    <title>ç«‹å†¬ç¥ç¦ï¼ˆå®°æ²»ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a8edea 100%);
            min-height: 100vh;
            position: relative;
        }

        /* Entrance Popup */
        .entrance-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .popup-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: popupEnter 0.6s ease-out;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes popupEnter {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-content h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .popup-content p {
            color: #555;
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .claim-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        /* Blessing Card */
        .blessing-card {
            position: absolute;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 20px 30px;
            color: white;
            font-size: 18px;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            animation: floatUp 6s linear forwards;
            pointer-events: auto;
            white-space: nowrap;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.8) rotate(0deg);
            }
            3% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(var(--random-rotation));
            }
            97% {
                opacity: 1;
                transform: translateY(-100vh) scale(1) rotate(var(--random-rotation));
            }
            100% {
                opacity: 0;
                transform: translateY(-110vh) scale(0.9) rotate(var(--random-rotation));
            }
        }

        /* Click Feedback */
        .click-feedback {
            position: fixed;
            color: #ffd700;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            z-index: 999;
            animation: feedbackFloat 1s ease-out forwards;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        @keyframes feedbackFloat {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Blessing Rain Button */
        .blessing-rain-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .blessing-rain-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        /* Snow Particle */
        .snowflake {
            position: fixed;
            color: white;
            font-size: 14px;
            pointer-events: none;
            z-index: 1;
            animation: fall linear infinite;
            opacity: 0.7;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Easter Egg Popup */
        .easter-egg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: none;
            max-width: 90%;
        }

        .easter-egg h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .easter-egg p {
            color: #555;
            line-height: 1.8;
            font-size: 16px;
        }

        .close-egg {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            color: white;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
            min-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
            font-size: 12px;
            display: none;
        }

        .stat-item {
            margin: 10px 0;
            font-size: 14px;
        }

        .stat-label {
            color: #a8edea;
            font-weight: 600;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
        }

        .user-item .user-nickname {
            color: #ffd700;
            font-weight: 600;
        }

        .user-item .user-time {
            color: #a8edea;
            font-size: 11px;
        }

        .user-item .user-stats {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            margin-top: 4px;
        }

        /* Music Control */
        .music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .music-btn {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .music-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .nickname-input {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-size: 16px;
            width: 80%;
            max-width: 250px;
        }

        .nickname-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .nickname-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .popup-content {
                padding: 30px 20px;
                margin: 20px;
            }

            .popup-content h1 {
                font-size: 20px;
                line-height: 1.4;
            }

            .popup-content p {
                font-size: 14px;
                line-height: 1.6;
            }

            .claim-btn {
                padding: 14px 40px;
                font-size: 16px;
                min-height: 48px;
                min-width: 120px;
            }

            .blessing-card {
                font-size: 14px;
                padding: 12px 16px;
            }

            .blessing-rain-btn {
                font-size: 14px;
                padding: 14px 32px;
                bottom: 20px;
                min-height: 48px;
            }

            .music-control {
                top: 10px;
                right: 10px;
            }

            .music-btn {
                font-size: 12px;
                padding: 10px 18px;
                min-height: 40px;
            }

            .admin-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                min-width: unset;
                max-width: unset;
                max-height: 70vh;
            }

            .admin-toggle {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            .easter-egg {
                padding: 30px 20px;
            }

            .easter-egg h2 {
                font-size: 20px;
            }

            .easter-egg p {
                font-size: 14px;
            }

            .close-egg {
                padding: 12px 30px;
                font-size: 14px;
                min-height: 44px;
            }

            .nickname-input {
                width: 100%;
                max-width: 100%;
                padding: 14px 20px;
                font-size: 16px;
                min-height: 48px;
            }
        }

        @media (max-width: 480px) {
            .popup-content {
                padding: 25px 15px;
                margin: 15px;
                border-radius: 20px;
            }

            .popup-content h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .popup-content p {
                font-size: 13px;
                margin-bottom: 20px;
            }

            .claim-btn {
                padding: 12px 35px;
                font-size: 15px;
            }

            .blessing-rain-btn {
                font-size: 13px;
                padding: 12px 28px;
            }

            .blessing-card {
                font-size: 13px;
                padding: 10px 14px;
                white-space: normal;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Entrance Popup -->
    <div class="entrance-popup" id="entrancePopup">
        <div class="popup-content">
            <h1>ğŸ å®°æ²»é€ä½ ä¸€ä»½ç«‹å†¬çš„å°å°çš„ç¤¼ç‰©</h1>
            <p>ç«‹å†¬å•¦ï¼Œè®©å¥½è¿å’Œæ¸©æš–ä¸€èµ·åˆ°ä½ èº«è¾¹ï½<br>ä½ è‹¥è§‰å¾—æœ‰è¶£ï¼Œæ¬¢è¿é“¾æ¥æˆ‘Vï¼šzaizhi1112</p>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
            <br>
            <button class="claim-btn" id="claimBtn">ç‚¹å‡»é¢†å–</button>
        </div>
    </div>

    <!-- Blessing Rain Button -->
    <button class="blessing-rain-btn" id="blessingRainBtn" style="display: none;">å†æ¥ä¸€ç‚¹ç¦æ°” âœ¨</button>

    <!-- Easter Egg Popup -->
    <div class="easter-egg" id="easterEgg">
        <h2 id="eggTitle"></h2>
        <p id="eggMessage"></p>
        <button class="close-egg" onclick="closeEasterEgg()">æ¸©æš–æ¥æ”¶ ğŸ’–</button>
    </div>

    <!-- Music Control -->
    <div class="music-control" id="musicControl" style="display: none;">
        <button class="music-btn" id="musicBtn">ğŸµ å¼€å¯éŸ³ä¹</button>
    </div>

    <!-- Background Music -->
    <audio id="bgMusic" loop>
        <source src="winter-music.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>

    <!-- Admin Panel -->
    <button class="admin-toggle" id="adminToggle" title="Admin">ğŸ‘‘</button>
    <div class="admin-panel" id="adminPanel">
        <h3 style="margin-bottom: 15px; color: #a8edea;">ğŸ“Š ç»Ÿè®¡é¢æ¿</h3>

        <!-- Current User Stats -->
        <div class="stats-section">
            <h4 style="color: #fff; margin: 15px 0 10px 0; font-size: 14px;">å½“å‰ç”¨æˆ·</h4>
            <div class="stat-item"><span class="stat-label">æ˜µç§°:</span> <span id="statNickname">-</span></div>
            <div class="stat-item"><span class="stat-label">åœç•™æ—¶é—´:</span> <span id="statTime">0s</span></div>
            <div class="stat-item"><span class="stat-label">ç‚¹å‡»æ¬¡æ•°:</span> <span id="statClicks">0</span></div>
            <div class="stat-item"><span class="stat-label">çˆ†å‘æŒ‰é’®:</span> <span id="statRains">0</span></div>
            <div class="stat-item"><span class="stat-label">ç¥ç¦æ¡æ•°:</span> <span id="statBlessings">0</span></div>
        </div>

        <!-- Total Stats -->
        <div class="stats-section" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 15px;">
            <h4 style="color: #fff; margin: 10px 0; font-size: 14px;">æ€»æ•°æ®</h4>
            <div class="stat-item"><span class="stat-label">æ€»ç”¨æˆ·æ•°:</span> <span id="statTotalUsers">0</span></div>
            <div class="stat-item"><span class="stat-label">æ€»åœç•™æ—¶é—´:</span> <span id="statTotalTime">0s</span></div>
            <div class="stat-item"><span class="stat-label">æ€»ç‚¹å‡»æ¬¡æ•°:</span> <span id="statTotalClicks">0</span></div>
            <div class="stat-item"><span class="stat-label">æ€»çˆ†å‘æ¬¡æ•°:</span> <span id="statTotalRains">0</span></div>
            <div class="stat-item"><span class="stat-label">æ€»ç¥ç¦æ¡æ•°:</span> <span id="statTotalBlessings">0</span></div>
        </div>

        <!-- User List -->
        <div class="stats-section" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 15px; max-height: 200px; overflow-y: auto;">
            <h4 style="color: #fff; margin: 10px 0; font-size: 14px;">ç”¨æˆ·åˆ—è¡¨ <span style="font-size: 11px; color: #a8edea;">(å…±<span id="userCount">0</span>äºº)</span></h4>
            <div id="userList" class="user-list"></div>
        </div>

        <!-- Export Button -->
        <div style="margin-top: 15px; text-align: center;">
            <button class="export-btn" id="exportBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 12px; width: 100%;">ğŸ“Š å¯¼å‡ºExcel</button>
        </div>
    </div>

    <script>
        // Global Variables
        let nickname = '';
        let userStats = {
            startTime: null,
            clickCount: 0,
            rainCount: 0,
            blessingCount: 0,
            blessingTimes: []
        };

        let globalStats = JSON.parse(localStorage.getItem('globalStats') || '{"users": [], "totalTime": 0, "totalClicks": 0, "totalRains": 0, "totalBlessings": 0}');
        let currentUserData = null;
        let blessingInterval;
        let isGenerating = false;
        let blessingCount = 0;
        let stayTimeInterval;
        let easterEgg66Shown = false;
        let easterEggLongShown = false;
        let adminClickCount = 0;

        // Recalculate total stats from all users
        function recalculateTotalStats() {
            globalStats.totalTime = globalStats.users.reduce((sum, user) => sum + (user.stayTime || 0), 0);
            globalStats.totalClicks = globalStats.users.reduce((sum, user) => sum + (user.clickCount || 0), 0);
            globalStats.totalRains = globalStats.users.reduce((sum, user) => sum + (user.rainCount || 0), 0);
            globalStats.totalBlessings = globalStats.users.reduce((sum, user) => sum + (user.blessingCount || 0), 0);
        }

        // Recalculate on page load
        recalculateTotalStats();

        // Blessing Library (30 blessings)
        const blessings = [
            'ç«‹å†¬å¿«ä¹ï¼Œæ„¿ä½ çš„ç”Ÿæ´»å¦‚é›ªèŠ±èˆ¬çº¯æ´ç¾å¥½ï½ â„ï¸âœ¨',
            'æ„¿ä½ åœ¨è¿™ä¸ªå†¬å¤©æ”¶åˆ°æ»¡æ»¡çš„æ¸©æš–ä¸çˆ±æ„ âœ¨ğŸ’•',
            'ç«‹å†¬å·²è‡³ï¼Œå¥½è¿å’Œå¹¸ç¦æ­£åœ¨è·¯ä¸Šå¥”å‘ä½ ï½ ğŸš€ğŸ’',
            'æ„¿ä½ çš„å†¬å¤©ä¸å¯’å†·ï¼Œå› ä¸ºæœ‰æˆ‘çœŸæŒšçš„ç¥ç¦ ğŸ’–ğŸ”¥',
            'ç«‹å†¬å¿«ä¹ï¼æ„¿ä½ çš„æ¯ä¸€å¤©éƒ½åƒé˜³å…‰ä¸€æ ·æ¸©æš–ï½ â˜€ï¸ğŸ˜Š',
            'åœ¨è¿™ä¸ªç¾å¥½çš„ç«‹å†¬ï¼Œæ„¿æ‰€æœ‰ç¾å¥½éƒ½ä¸ä½ ç¯ç¯ç›¸æ‰£ï½ ğŸ§£ğŸ’',
            'ç«‹å†¬æ—¶èŠ‚ï¼Œæ„¿ä½ è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…ï½ ğŸŒ™ğŸ’¤',
            'æ„¿ä½ çš„ç”Ÿæ´»åƒå†¬æ—¥é‡Œçš„çƒ­èŒ¶ï¼Œæ¸©æš–è€Œé†‡é¦™ â˜•ğŸµ',
            'ç«‹å†¬å¿«ä¹ï¼è®©ç¥ç¦åƒé›ªèŠ±ä¸€æ ·é£˜è¿›ä½ çš„å¿ƒé‡Œ â„ï¸ğŸ’™',
            'æ„¿ä½ åœ¨è¿™ä¸ªå†¬å¤©ï¼Œæ”¶è·æ¯”å¾€å¹´æ›´å¤šçš„æ¸©æš–ï½ ğŸğŸŒŸ',
            'ç«‹å†¬åˆ°äº†ï¼Œæ„¿ä½ çš„ç¬‘å®¹å¦‚æ˜¥å¤©èˆ¬ç¿çƒ‚ï½ ğŸ˜ŠğŸŒ¸',
            'æ„¿è¿™ä»½ç¥ç¦èƒ½é©±æ•£ä½ å¿ƒä¸­çš„æ‰€æœ‰é˜´éœ¾ï½ ğŸŒˆâ˜ï¸',
            'ç«‹å†¬å¿«ä¹ï¼æ„¿ä½ çš„ç”Ÿæ´»æ°¸è¿œå……æ»¡é˜³å…‰å’Œå¸Œæœ› â˜€ï¸ğŸŒ»',
            'åœ¨è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­é‡Œï¼Œæ„¿ä½ è¢«æ‰€æœ‰ç¾å¥½æ‹¥æŠ±ï½ ğŸ¤—ğŸ’',
            'æ„¿ä½ çš„å†¬å¤©å……æ»¡è¯—æ„ï¼Œç”Ÿæ´»æ»¡æ˜¯æƒŠå–œï½ ğŸ“–ğŸ­',
            'ç«‹å†¬å¿«ä¹ï¼æ¯ä¸€å¤©éƒ½è¦å…ƒæ°”æ»¡æ»¡å“¦ï½ âš¡ğŸ’ª',
            'æ„¿ä½ åœ¨è¿™ä¸ªå†¬å­£ï¼Œæ‰€æœ‰æ¢¦æƒ³éƒ½èƒ½å¦‚æ„¿ä»¥å¿ï½ ğŸ¯ğŸŒ ',
            'ç«‹å†¬æ—¶èŠ‚ï¼Œæ¸©æš–å¸¸ä¼´ï¼Œå¥½è¿å¸¸åœ¨ï½ ğŸğŸŠ',
            'æ„¿ä½ åƒå†¬æ—¥é‡Œçš„æš–é˜³ï¼Œç…§äº®è‡ªå·±çš„åŒæ—¶ä¹Ÿæ¸©æš–ä»–äººï½ â˜€ï¸ğŸ‘«',
            'ç«‹å†¬å¿«ä¹ï¼æ„¿ä½ è¢«å²æœˆæ¸©æŸ”ä»¥å¾…ï½ ğŸ•°ï¸ğŸ’•',
            'åœ¨è¿™ä¸ªç¾å¥½çš„å­£èŠ‚ï¼Œæ„¿æ‰€æœ‰å¹¸ç¦éƒ½å‘ä½ èµ°æ¥ï½ ğŸŠğŸ¥³',
            'æ„¿ä½ çš„å†¬å¤©æ²¡æœ‰é—æ†¾ï¼Œåªæœ‰æ»¡æ»¡çš„æ”¶è·ä¸æ„ŸåŠ¨ï½ ğŸ§ºğŸ’',
            'ç«‹å†¬å¿«ä¹ï¼æ„¿ä½ æ¯å¤©éƒ½æœ‰å°ç¡®å¹¸ï½ ğŸ±â˜€ï¸',
            'æ„¿ä½ åœ¨è¿™ä¸ªå†¬å¤©ï¼Œæ„Ÿå—ç”Ÿæ´»ä¸­æ‰€æœ‰çš„å°ç¾å¥½ï½ ğŸŒºğŸ€',
            'ç«‹å†¬åˆ°äº†ï¼Œè®°å¾—ä¿æš–ï¼Œä¹Ÿè¦ä¿æŒå¥½å¿ƒæƒ…å“¦ï½ ğŸ§¥ğŸ˜„',
            'æ„¿ä½ çš„ç”Ÿæ´»åƒé›ªèŠ±ä¸€æ ·è½»ç›ˆè€Œç¾å¥½ï½ â„ï¸ğŸ•Šï¸',
            'ç«‹å†¬å¿«ä¹ï¼æ„¿ä½ æ°¸è¿œä¿æŒä¸€é¢—æ¸©æš–çš„å¿ƒ ğŸ’ğŸ’“',
            'åœ¨è¿™ä¸ªç«‹å†¬ï¼Œæ„¿ä½ æ”¶è·æ»¡æ»¡çš„ç¥ç¦ä¸æ„ŸåŠ¨ï½ ğŸğŸ’–',
            'æ„¿ä½ åœ¨è¿™ä¸ªå†¬å­£ï¼Œé‡è§æ›´å¥½çš„è‡ªå·±ï½ ğŸ”®âœ¨',
            'ç«‹å†¬å¿«ä¹ï¼è®©æ¸©æš–å’Œå¿«ä¹å¡«æ»¡ä½ çš„æ•´ä¸ªå†¬å¤©ï½ ğŸ”¥ğŸ‰'
        ];

        // URL Parameters
        const urlParams = new URLSearchParams(window.location.search);
        const urlName = urlParams.get('name');
        const urlFrom = urlParams.get('from');

        // Initialize
        window.addEventListener('load', () => {
            if (urlName) {
                updatePersonalizedBlessings();
            }
        });

        // Initialize event listeners when DOM is ready
        function initializeEventListeners() {
            // Entrance Button Click
            const claimBtn = document.getElementById('claimBtn');
            if (claimBtn) {
                claimBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    nickname = document.getElementById('nicknameInput').value || 'äº²çˆ±çš„æœ‹å‹';
                    userStats.startTime = Date.now();

                    // Create user data record
                    currentUserData = {
                        id: Date.now(),
                        nickname: nickname,
                        enterTime: new Date().toLocaleString('zh-CN'),
                        startTime: userStats.startTime,
                        clickCount: 0,
                        rainCount: 0,
                        blessingCount: 0
                    };

                    // Hide popup
                    const popup = document.getElementById('entrancePopup');
                    if (popup) popup.style.display = 'none';

                    // Show button
                    const blessingBtn = document.getElementById('blessingRainBtn');
                    if (blessingBtn) blessingBtn.style.display = 'block';

                    // Show music control
                    const musicControl = document.getElementById('musicControl');
                    if (musicControl) musicControl.style.display = 'block';

                    // Start generating blessings
                    startBlessingGeneration();

                    // Start stay time tracking
                    startStayTimeTracking();

                    // Update nickname in stats
                    const statNickname = document.getElementById('statNickname');
                    if (statNickname) statNickname.textContent = nickname;
                });
            }

            // Music Button Click
            const musicBtn = document.getElementById('musicBtn');
            if (musicBtn) {
                musicBtn.addEventListener('click', () => {
                    const audio = document.getElementById('bgMusic');
                    const musicBtn = document.getElementById('musicBtn');

                    if (audio.paused) {
                        audio.play().then(() => {
                            musicBtn.textContent = 'ğŸ”‡ å…³é—­éŸ³ä¹';
                        }).catch(error => {
                            console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                            alert('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³ä¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
                        });
                    } else {
                        audio.pause();
                        musicBtn.textContent = 'ğŸµ å¼€å¯éŸ³ä¹';
                    }
                });
            }

            // Blessing Rain Button
            const blessingRainBtn = document.getElementById('blessingRainBtn');
            if (blessingRainBtn) {
                blessingRainBtn.addEventListener('click', () => {
                    userStats.rainCount++;
                    if (currentUserData) {
                        currentUserData.rainCount++;
                    }
                    createBlessingRain();
                    triggerBlessingEasterEgg();
                });
            }

            // Admin Panel Toggle
            const adminToggle = document.getElementById('adminToggle');
            if (adminToggle) {
                adminToggle.addEventListener('click', () => {
                    adminClickCount++;
                    if (adminClickCount >= 10) {
                        showAdminLogin();
                    }
                });
            }

            // Export Excel Button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    exportToExcel();
                });
            }

            // Show admin toggle in bottom right
            setTimeout(() => {
                const adminToggle = document.getElementById('adminToggle');
                if (adminToggle) adminToggle.style.display = 'block';
            }, 5000);
        }

        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEventListeners);
        } else {
            initializeEventListeners();
        }

        // Save data when page is about to unload or refresh
        window.addEventListener('beforeunload', () => {
            saveCurrentUserData();
        });

        // Also save data periodically
        setInterval(() => {
            if (userStats.startTime && currentUserData) {
                const elapsed = Math.floor((Date.now() - userStats.startTime) / 1000);
                currentUserData.stayTime = elapsed;
                currentUserData.blessingCount = userStats.blessingCount;
            }
        }, 5000);

        // Start Blessing Generation
        function startBlessingGeneration() {
            if (isGenerating) return;
            isGenerating = true;

            blessingInterval = setInterval(() => {
                createBlessing();
            }, 300 + Math.random() * 200);

            createSnowflakes();
        }

        // Create Blessing Card
        function createBlessing(forcePosition = null) {
            const card = document.createElement('div');
            card.className = 'blessing-card';

            // Get random blessing
            let blessing = blessings[Math.floor(Math.random() * blessings.length)];

            // Personalize if name exists
            if (nickname && nickname !== 'äº²çˆ±çš„æœ‹å‹') {
                blessing = `${nickname}ï¼Œ${blessing.replace(/^[æ„¿ä½ ]/, '')}`;
            }

            // Personalize from URL
            if (urlFrom) {
                blessing += ` (æ¥è‡ª${urlFrom}çš„æ¸©æš–ç¥ç¦)`;
            }

            card.textContent = blessing;

            // Calculate position
            let randomX, randomY;
            const cardWidth = 260; // Approximate card width (increased for emoji)
            const cardHeight = 70; // Approximate card height
            const existingCards = document.querySelectorAll('.blessing-card');
            const margin = 30; // Minimum margin between cards

            if (forcePosition) {
                // Use provided position (for blessing rain), but still check for overlap
                let attempts = 0;
                const maxAttempts = 20;
                do {
                    randomX = forcePosition.x;
                    randomY = forcePosition.y;

                    // Check if this position overlaps with existing cards
                    let overlaps = false;
                    for (let i = 0; i < existingCards.length; i++) {
                        const existingCard = existingCards[i];
                        const existingRect = existingCard.getBoundingClientRect();
                        const newRect = {
                            left: randomX,
                            top: randomY,
                            right: randomX + cardWidth,
                            bottom: randomY + cardHeight
                        };

                        // Check if rectangles overlap
                        if (!(newRect.right < existingRect.left - margin ||
                              newRect.left > existingRect.right + margin ||
                              newRect.bottom < existingRect.top - margin ||
                              newRect.top > existingRect.bottom + margin)) {
                            overlaps = true;
                            // Try a slightly different position
                            randomX = Math.max(margin, randomX + (Math.random() - 0.5) * 100);
                            break;
                        }
                    }

                    if (!overlaps) break;
                    attempts++;
                } while (attempts < maxAttempts);
            } else {
                // Find non-overlapping position for single blessings
                let attempts = 0;
                const maxAttempts = 20;

                do {
                    const maxX = Math.max(0, window.innerWidth - cardWidth);
                    randomX = Math.random() * maxX;
                    randomY = window.innerHeight - 50;

                    // Check if this position overlaps with existing cards
                    let overlaps = false;
                    for (let i = 0; i < existingCards.length; i++) {
                        const existingCard = existingCards[i];
                        const existingRect = existingCard.getBoundingClientRect();
                        const newRect = {
                            left: randomX,
                            top: randomY,
                            right: randomX + cardWidth,
                            bottom: randomY + cardHeight
                        };

                        // Check if rectangles overlap
                        if (!(newRect.right < existingRect.left - margin ||
                              newRect.left > existingRect.right + margin ||
                              newRect.bottom < existingRect.top - margin ||
                              newRect.top > existingRect.bottom + margin)) {
                            overlaps = true;
                            break;
                        }
                    }

                    if (!overlaps) break;
                    attempts++;
                } while (attempts < maxAttempts);
            }

            const randomRotation = (Math.random() - 0.5) * 20 + 'deg';

            card.style.left = randomX + 'px';
            card.style.top = randomY + 'px';
            // Set z-index to prevent overlapping (newer cards on top)
            card.style.zIndex = 1000 + blessingCount;
            card.style.setProperty('--random-rotation', randomRotation);

            // Click event
            card.addEventListener('click', (e) => {
                e.stopPropagation();
                showClickFeedback(e.clientX, e.clientY);
                userStats.clickCount++;
                if (currentUserData) {
                    currentUserData.clickCount++;
                }
                blessingCount++;

                if (blessingCount === 66 && !easterEgg66Shown) {
                    showEasterEgg('ğŸ‰ å½©è›‹æ—¶åˆ»', 'ä½ å·²ç»æ”¶åˆ°äº† 66 æ¡å¥½è¿ï¼ä»Šå¤©ç¨³äº†ï½');
                    easterEgg66Shown = true;
                }
            });

            document.body.appendChild(card);
            userStats.blessingCount++;
            blessingCount++;
            userStats.blessingTimes.push(Date.now());

            // Update global stats
            globalStats.totalBlessings++;
            saveGlobalStats();

            // Remove after animation using requestAnimationFrame for better compatibility
            const removeCard = () => {
                if (card && card.parentNode) {
                    card.parentNode.removeChild(card);
                }
            };

            // Use setTimeout as a fallback, but wrapped in a try-catch
            try {
                setTimeout(removeCard, 6000);
            } catch (error) {
                console.log('Error removing card:', error);
            }
        }

        // Create Blessing Rain (10 blessings at once with distributed positions)
        function createBlessingRain() {
            // Generate distributed X positions for 10 blessings to avoid overlapping
            const positions = [];
            const blessingCount = 10;
            const cardWidth = 260; // Same as in createBlessing
            const margin = 20; // Minimum margin between cards

            // Calculate grid positions based on screen width
            const isLandscape = window.innerWidth > window.innerHeight;
            const cols = isLandscape ? 5 : 3;

            // Calculate horizontal spacing
            const availableWidth = window.innerWidth - (cols * cardWidth) - (margin * (cols + 1));
            const spacingX = availableWidth / (cols + 1);

            // Generate grid X positions
            for (let col = 0; col < cols; col++) {
                if (positions.length < blessingCount) {
                    const x = Math.max(margin, col * (cardWidth + spacingX) + spacingX + (Math.random() * 20 - 10));
                    positions.push({ x, y: window.innerHeight - 50 }); // All start from bottom
                }
            }

            // If we need more positions, add more rows
            for (let col = 0; col < cols && positions.length < blessingCount; col++) {
                const x = Math.max(margin, col * (cardWidth + spacingX) + spacingX + (Math.random() * 20 - 10));
                positions.push({ x, y: window.innerHeight - 50 }); // All start from bottom
            }

            // Shuffle positions to add randomness
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }

            // Create blessings at distributed positions
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    createBlessing(positions[i]);
                }, i * 50);
            }
        }

        // Show Click Feedback
        function showClickFeedback(x, y) {
            const feedback = document.createElement('div');
            feedback.className = 'click-feedback';
            feedback.textContent = Math.random() > 0.5 ? 'å¥½è¿ï¼‹1' : 'æš–æ„ï¼‹1';
            feedback.style.left = x + 'px';
            feedback.style.top = y + 'px';

            document.body.appendChild(feedback);

            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 1000);
        }

        // Easter Egg for Blessing Rain
        function triggerBlessingEasterEgg() {
            if (userStats.rainCount === 5 && !easterEggLongShown) {
                showEasterEgg('ğŸŒŸ ç¦æ°”æ»¡æ»¡', 'ä½ çš„ç¦æ°”æ­£åœ¨æ±‡èšï¼ç»§ç»­é¢†å–æ›´å¤šæ¸©æš–å§ï½');
            }
        }

        // Show Easter Egg
        function showEasterEgg(title, message) {
            document.getElementById('eggTitle').textContent = title;
            document.getElementById('eggMessage').textContent = message;
            document.getElementById('easterEgg').style.display = 'block';
        }

        // Close Easter Egg
        function closeEasterEgg() {
            document.getElementById('easterEgg').style.display = 'none';
        }

        // Create Snowflakes
        function createSnowflakes() {
            setInterval(() => {
                if (document.querySelectorAll('.snowflake').length < 50) {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.innerHTML = 'â„ï¸';
                    snowflake.style.left = Math.random() * window.innerWidth + 'px';
                    snowflake.style.animationDuration = 3 + Math.random() * 4 + 's';
                    snowflake.style.opacity = 0.3 + Math.random() * 0.4;

                    document.body.appendChild(snowflake);

                    setTimeout(() => {
                        if (snowflake.parentNode) {
                            snowflake.parentNode.removeChild(snowflake);
                        }
                    }, 7000);
                }
            }, 200);
        }

        // Background Music
        function playBackgroundMusic() {
            console.log('ğŸµ Playing background music...');
            const audio = document.getElementById('bgMusic');
            if (audio) {
                audio.volume = 0.5; // è®¾ç½®éŸ³é‡ä¸º50%
                audio.play().catch(error => {
                    console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                });
            }
        }

        // Stay Time Tracking
        function startStayTimeTracking() {
            stayTimeInterval = setInterval(() => {
                if (userStats.startTime) {
                    const elapsed = Math.floor((Date.now() - userStats.startTime) / 1000);
                    document.getElementById('statTime').textContent = elapsed + 's';
                    document.getElementById('statClicks').textContent = userStats.clickCount;
                    document.getElementById('statRains').textContent = userStats.rainCount;
                    document.getElementById('statBlessings').textContent = userStats.blessingCount;

                    // Update current user data
                    if (currentUserData) {
                        currentUserData.stayTime = elapsed;
                        currentUserData.blessingCount = userStats.blessingCount;
                    }

                    // Long stay easter egg (3 minutes 48 seconds = 228 seconds)
                    if (elapsed >= 228 && !easterEggLongShown) {
                        showEasterEgg('ğŸµ ç‰¹æ®Šå½©è›‹', 'è°¢è°¢ä½ åœç•™3åˆ†é’Ÿ48ç§’ï¼Œè¿™é¦–æˆ‘ç”¨AIåšçš„éŸ³ä¹çŒ®ç»™å±å¹•å‰çš„ä½ ï¼å°å½©è›‹å•¦ï¼å®°æ²»å†æ¬¡ç¥ä½ åœ¨è¿™ä¸ªå†¬å¤©æ€»æ˜¯æ”¶è·æš–æš–ï¼Œçƒ¦æ¼å°‘ä¸€äº›ï¼Œå¹¸ç¦å¸¸ä¼´ä½ èº«è¾¹ï¼');
                        easterEggLongShown = true;
                    }
                }

                // Update global stats
                document.getElementById('statTotalUsers').textContent = globalStats.users.length;
                document.getElementById('statTotalTime').textContent = globalStats.totalTime + 's';
                document.getElementById('statTotalClicks').textContent = globalStats.totalClicks;
                document.getElementById('statTotalRains').textContent = globalStats.totalRains;
                document.getElementById('statTotalBlessings').textContent = globalStats.totalBlessings;

                // Update user list
                updateUserList();
            }, 1000);
        }

        // Update User List Display
        function updateUserList() {
            const userListContainer = document.getElementById('userList');
            const userCountSpan = document.getElementById('userCount');

            if (!userListContainer) return;

            userCountSpan.textContent = globalStats.users.length;

            if (globalStats.users.length === 0) {
                userListContainer.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 11px; text-align: center;">æš‚æ— ç”¨æˆ·æ•°æ®</div>';
                return;
            }

            // Show last 10 users (reverse order to show newest first)
            const recentUsers = globalStats.users.slice(-10).reverse();
            userListContainer.innerHTML = recentUsers.map(user => {
                const minutes = Math.floor(user.stayTime / 60);
                const seconds = user.stayTime % 60;
                return `
                    <div class="user-item">
                        <div class="user-nickname">${user.nickname}</div>
                        <div class="user-time">${user.enterTime}</div>
                        <div class="user-stats">
                            åœç•™: ${minutes}åˆ†${seconds}ç§’ |
                            ç‚¹å‡»: ${user.clickCount} |
                            çˆ†å‘: ${user.rainCount} |
                            ç¥ç¦: ${user.blessingCount}
                        </div>
                    </div>
                `;
            }).join('');

            // Recalculate total stats
            recalculateTotalStats();
        }

        // Save Current User Data
        function saveCurrentUserData() {
            if (userStats.startTime && currentUserData) {
                const elapsed = Math.floor((Date.now() - userStats.startTime) / 1000);
                currentUserData.stayTime = elapsed;
                currentUserData.blessingCount = userStats.blessingCount;

                // Check if user data already exists
                const existingIndex = globalStats.users.findIndex(u => u.id === currentUserData.id);
                if (existingIndex !== -1) {
                    // Update existing user data
                    globalStats.users[existingIndex] = {...currentUserData};
                } else {
                    // Add new user data
                    globalStats.users.push({...currentUserData});
                }

                // Recalculate total stats from all users
                recalculateTotalStats();
                saveGlobalStats();
            }
        }

        // Save Global Stats
        function saveGlobalStats() {
            localStorage.setItem('globalStats', JSON.stringify(globalStats));
        }

        // Export to Excel (CSV format with UTF-8 BOM for Excel compatibility)
        function exportToExcel() {
            if (globalStats.users.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            try {
                // Create CSV content with proper formatting
                const headers = ['åºå·', 'æ˜µç§°', 'è¿›å…¥æ—¶é—´', 'åœç•™æ—¶é—´(ç§’)', 'åœç•™æ—¶é—´(åˆ†:ç§’)', 'ç‚¹å‡»æ¬¡æ•°', 'çˆ†å‘æ¬¡æ•°', 'ç¥ç¦æ¡æ•°'];
                const rows = [];

                // Add header row
                rows.push(headers);

                // Add user data rows
                globalStats.users.forEach((user, index) => {
                    const minutes = Math.floor((user.stayTime || 0) / 60);
                    const seconds = (user.stayTime || 0) % 60;
                    const row = [
                        index + 1,
                        user.nickname || 'æœªè¾“å…¥',
                        user.enterTime || new Date().toLocaleString('zh-CN'),
                        user.stayTime || 0,
                        `${minutes}:${seconds.toString().padStart(2, '0')}`,
                        user.clickCount || 0,
                        user.rainCount || 0,
                        user.blessingCount || 0
                    ];
                    rows.push(row);
                });

                // Add empty row for spacing
                rows.push([]);

                // Add summary row
                const totalMinutes = Math.floor(globalStats.totalTime / 60);
                const totalSeconds = globalStats.totalTime % 60;
                rows.push([
                    'æ€»è®¡',
                    `${globalStats.users.length}äºº`,
                    '',
                    globalStats.totalTime,
                    `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`,
                    globalStats.totalClicks,
                    globalStats.totalRains,
                    globalStats.totalBlessings
                ]);

                // Add empty row
                rows.push([]);

                // Add export info
                rows.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN'), '', '', '', '', '', '']);
                rows.push(['æ•°æ®æ¥æº', 'ç«‹å†¬ç¥ç¦ï¼ˆå®°æ²»ï¼‰', '', '', '', '', '', '']);

                // Format data for CSV (escape quotes and wrap in quotes)
                const csvLines = rows.map(row => {
                    return row.map(cell => {
                        // Convert to string and escape double quotes
                        const str = String(cell || '');
                        const escaped = str.replace(/"/g, '""');
                        return `"${escaped}"`;
                    }).join(',');
                });

                // Add UTF-8 BOM for Excel compatibility
                const BOM = '\uFEFF';
                const csvContent = BOM + csvLines.join('\n');

                // Create download link
                const fileName = `ç«‹å†¬ç¥ç¦æ•°æ®_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '')}.csv`;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Cleanup
                setTimeout(() => URL.revokeObjectURL(url), 100);

                alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å·²ä¿å­˜ä¸ºCSVæ ¼å¼ï¼Œ\nå¯ç”¨Excelæˆ–WPSç›´æ¥æ‰“å¼€ã€‚\n\næ–‡ä»¶åï¼š' + fileName);
            } catch (error) {
                console.error('Export error:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // Admin Login
        function showAdminLogin() {
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
            if (password === '1323701508wl') {
                document.getElementById('adminPanel').style.display = 'block';
                // Refresh data when panel opens
                setTimeout(() => {
                    updateUserList();
                    document.getElementById('statTotalUsers').textContent = globalStats.users.length;
                    document.getElementById('statTotalTime').textContent = globalStats.totalTime + 's';
                    document.getElementById('statTotalClicks').textContent = globalStats.totalClicks;
                    document.getElementById('statTotalRains').textContent = globalStats.totalRains;
                    document.getElementById('statTotalBlessings').textContent = globalStats.totalBlessings;
                }, 100);
            } else if (password !== null) {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        // Update Personalized Blessings
        function updatePersonalizedBlessings() {
            if (urlName) {
                // Modify blessing templates to include the name
                for (let i = 0; i < blessings.length; i++) {
                    if (!blessings[i].includes('ï¼Œ')) {
                        blessings[i] = urlName + 'ï¼Œ' + blessings[i];
                    }
                }
            }
        }
    </script>
</body>
</html>